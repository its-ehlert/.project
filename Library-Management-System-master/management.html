<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management Dashboard - Magenta</title>
    <link rel="stylesheet" href="../frontend/css/style.css">
    <link rel="stylesheet" href="../frontend/css/responsive.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="admin-body">
    <!-- Admin Header -->
    <header class="admin-header">
        <div class="admin-header-content">
            <div class="admin-logo">
                <i class="fas fa-book-open"></i>
                <span>Magenta Management</span>
            </div>
            
            <div class="admin-actions">
                <div class="admin-search">
                    <input type="text" placeholder="Search books..." id="searchText">
                    <i class="fas fa-search"></i>
                </div>
                
                <div class="admin-user">
                    <img src="../frontend/images/admin-avatar.jpg" alt="Admin" id="adminAvatar">
                    <div class="admin-user-info">
                        <span id="adminName">Admin User</span>
                        <span id="adminRole">Administrator</span>
                    </div>
                    <div class="admin-dropdown">
                        <button class="admin-dropdown-btn">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="admin-dropdown-menu">
                            <a href="#profile"><i class="fas fa-user"></i> Profile</a>
                            <a href="#settings"><i class="fas fa-cog"></i> Settings</a>
                            <a href="#" id="adminLogout"><i class="fas fa-sign-out-alt"></i> Logout</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Admin Layout -->
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <nav class="admin-nav">
                <ul class="admin-nav-list">
                    <li class="admin-nav-item">
                        <a href="#dashboard" class="admin-nav-link active" data-tab="dashboard">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="admin-nav-item">
                        <a href="#books" class="admin-nav-link" data-tab="books">
                            <i class="fas fa-book"></i>
                            <span>Books</span>
                        </a>
                    </li>
                    <li class="admin-nav-item">
                        <a href="#add-book" class="admin-nav-link" data-tab="add-book">
                            <i class="fas fa-plus"></i>
                            <span>Add Book</span>
                        </a>
                    </li>
                    <li class="admin-nav-item">
                        <a href="#categories" class="admin-nav-link" data-tab="categories">
                            <i class="fas fa-tags"></i>
                            <span>Categories</span>
                        </a>
                    </li>
                    <li class="admin-nav-item">
                        <a href="#reports" class="admin-nav-link" data-tab="reports">
                            <i class="fas fa-chart-bar"></i>
                            <span>Reports</span>
                        </a>
                    </li>
                    <li class="admin-nav-item">
                        <a href="#settings" class="admin-nav-link" data-tab="settings">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <!-- Dashboard Tab -->
            <div class="admin-tab active" id="dashboard">
                <div class="admin-tab-header">
                    <h1>Dashboard</h1>
                    <p>Welcome to Magenta Library Management System</p>
                </div>

                <!-- Statistics Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-book"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalBooks">0</h3>
                            <p>Total Books</p>
                            <span class="stat-change positive">Library Collection</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalUsers">0</h3>
                            <p>Total Users</p>
                            <span class="stat-change positive">Registered Users</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-eye"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalViews">0</h3>
                            <p>Total Views</p>
                            <span class="stat-change positive">Book Views</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="favoriteBooks">0</h3>
                            <p>Favorite Books</p>
                            <span class="stat-change positive">Marked as Favorite</span>
                        </div>
                    </div>
                </div>

                <!-- Recent Books -->
                <div class="admin-sections">
                    <div class="admin-section">
                        <div class="section-header">
                            <h2>Recent Books</h2>
                            <a href="#books" class="view-all">View All</a>
                        </div>
                        <div class="recent-books" id="recentBooks">
                            <!-- Recent books will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Books Tab -->
            <div class="admin-tab" id="books">
                <div class="admin-tab-header">
                    <h1>Book Management</h1>
                    <button class="btn btn-primary" onclick="showAddBookTab()">
                        <i class="fas fa-plus"></i> Add New Book
                    </button>
                </div>

                <div class="admin-filters">
                    <div class="filter-group">
                        <input type="text" placeholder="Search books..." id="bookSearch">
                        <select id="bookTypeFilter">
                            <option value="">All Types</option>
                            <option value="Anime">Anime</option>
                            <option value="Programming">Programming</option>
                            <option value="Fiction">Fiction</option>
                            <option value="Non-Fiction">Non-Fiction</option>
                            <option value="Science">Science</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="admin-table-container">
                    <table class="admin-table" id="booksTable">
                        <thead>
                            <tr>
                                <th>Book</th>
                                <th>Author</th>
                                <th>Type</th>
                                <th>ISBN</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="booksTableBody">
                            <!-- Books will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Add Book Tab -->
            <div class="admin-tab" id="add-book">
                <div class="admin-tab-header">
                    <h1>Add New Book</h1>
                    <p>Add a new book to your library collection</p>
                </div>

                <div class="add-book-form-container">
                    <form id="libraryForm" class="modern-form">
                        <div class="form-section">
                            <h3>Basic Information</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="bookName">Book Name *</label>
                                    <input type="text" id="bookName" placeholder="Enter book name" required>
                                </div>
                                <div class="form-group">
                                    <label for="author">Author *</label>
                                    <input type="text" id="author" placeholder="Enter author name" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="isbnno">ISBN Number</label>
                                    <input type="text" id="isbnno" placeholder="ISBN Number (10/13 digits)">
                                </div>
                                <div class="form-group">
                                    <label for="edition">Edition</label>
                                    <input type="number" id="edition" placeholder="Edition number">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="bookurl">Book URL</label>
                                <input type="url" id="bookurl" placeholder="Book URL (optional)">
                            </div>

                            <div class="form-group">
                                <label for="publicationdate">Publication Date</label>
                                <input type="date" id="publicationdate">
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>Book Type</h3>
                            <div class="book-type-options">
                                <label class="type-option">
                                    <input type="radio" name="type" value="Anime">
                                    <div class="option-content">
                                        <i class="fas fa-user"></i>
                                        <span>Anime</span>
                                    </div>
                                </label>
                                <label class="type-option">
                                    <input type="radio" name="type" value="Programming">
                                    <div class="option-content">
                                        <i class="fas fa-code"></i>
                                        <span>Programming</span>
                                    </div>
                                </label>
                                <label class="type-option">
                                    <input type="radio" name="type" value="Fiction">
                                    <div class="option-content">
                                        <i class="fas fa-book"></i>
                                        <span>Fiction</span>
                                    </div>
                                </label>
                                <label class="type-option">
                                    <input type="radio" name="type" value="Non-Fiction">
                                    <div class="option-content">
                                        <i class="fas fa-graduation-cap"></i>
                                        <span>Non-Fiction</span>
                                    </div>
                                </label>
                                <label class="type-option">
                                    <input type="radio" name="type" value="Science">
                                    <div class="option-content">
                                        <i class="fas fa-flask"></i>
                                        <span>Science</span>
                                    </div>
                                </label>
                                <label class="type-option">
                                    <input type="radio" name="type" value="Other">
                                    <div class="option-content">
                                        <i class="fas fa-ellipsis-h"></i>
                                        <span>Other</span>
                                    </div>
                                </label>
                            </div>
                            <div class="form-group" id="newTypeGroup" style="display: none;">
                                <label for="newType">Custom Type</label>
                                <input type="text" id="newType" placeholder="Enter custom book type">
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>Additional Settings</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="fav-toggle">
                                        <span class="checkmark"></span>
                                        Mark as Favorite
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="read-toggle">
                                        <span class="checkmark"></span>
                                        Mark as Read
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Add Book
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                <i class="fas fa-undo"></i> Reset Form
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Categories Tab -->
            <div class="admin-tab" id="categories">
                <div class="admin-tab-header">
                    <h1>Category Management</h1>
                    <button class="btn btn-primary" onclick="showAddCategoryModal()">
                        <i class="fas fa-plus"></i> Add New Category
                    </button>
                </div>

                <div class="categories-grid" id="categoriesGrid">
                    <!-- Categories will be loaded here -->
                </div>
            </div>

            <!-- Reports Tab -->
            <div class="admin-tab" id="reports">
                <div class="admin-tab-header">
                    <h1>Reports & Analytics</h1>
                </div>

                <div class="reports-grid">
                    <div class="report-card">
                        <h3>Book Statistics</h3>
                        <div class="report-chart" id="bookStatsChart">
                            <!-- Chart will be loaded here -->
                        </div>
                    </div>

                    <div class="report-card">
                        <h3>Popular Categories</h3>
                        <div class="category-stats" id="categoryStats">
                            <!-- Category statistics will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="admin-tab" id="settings">
                <div class="admin-tab-header">
                    <h1>System Settings</h1>
                </div>

                <div class="settings-grid">
                    <div class="settings-card">
                        <h3>General Settings</h3>
                        <form class="settings-form" id="generalSettingsForm">
                            <div class="form-group">
                                <label>Library Name</label>
                                <input type="text" value="Magenta Library" id="libraryName">
                            </div>
                            <div class="form-group">
                                <label>Admin Email</label>
                                <input type="email" value="admin@magenta.com" id="adminEmail">
                            </div>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Book Viewer Modal -->
    <div class="modal" id="bookViewerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalBookTitle">Book Details</h2>
                <button class="modal-close" onclick="closeBookModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBookContent">
                <!-- Book details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeBookModal()">Close</button>
                <button class="btn btn-primary" id="downloadBookBtn" onclick="downloadBook()" style="display: none;">
                    <i class="fas fa-download"></i> Download Book
                </button>
            </div>
        </div>
    </div>

    <!-- Message shown on successful adding of book -->
    <div class="notification" id="message"></div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner"></div>
    </div>

    <!-- Scripts -->
    <script src="../frontend/js/main.js"></script>
    <script src="../frontend/js/api.js"></script>
    <script src="../frontend/js/auth.js"></script>
    <script>
        // Initialize admin dashboard functionality
        class ManagementDashboard {
            constructor() {
                this.currentTab = 'dashboard';
                this.init();
            }

            init() {
                this.bindEvents();
                this.loadDashboardData();
                this.initializeBookManagement();
                console.log('ManagementDashboard initialized');
            }

            bindEvents() {
                // Navigation
                document.querySelectorAll('.admin-nav-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.switchTab(e.target.closest('.admin-nav-link').dataset.tab);
                    });
                });

                // Search functionality
                const searchInput = document.getElementById('searchText');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        this.handleSearch(e.target.value);
                    });
                }

                // Logout
                const logoutBtn = document.getElementById('adminLogout');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.logout();
                    });
                }
            }

            switchTab(tabName) {
                console.log('Switching to tab:', tabName);
                // Hide all tabs
                document.querySelectorAll('.admin-tab').forEach(tab => {
                    tab.classList.remove('active');
                });

                // Remove active class from all nav links
                document.querySelectorAll('.admin-nav-link').forEach(link => {
                    link.classList.remove('active');
                });

                // Show selected tab
                const selectedTab = document.getElementById(tabName);
                if (selectedTab) {
                    selectedTab.classList.add('active');
                }

                // Add active class to nav link
                const selectedLink = document.querySelector(`[data-tab="${tabName}"]`);
                if (selectedLink) {
                    selectedLink.classList.add('active');
                }

                // Load tab-specific data
                this.loadTabData(tabName);
            }

            loadTabData(tabName) {
                switch (tabName) {
                    case 'dashboard':
                        this.loadDashboardData();
                        break;
                    case 'books':
                        this.loadBooks();
                        break;
                    case 'add-book':
                        this.initializeAddBookForm();
                        break;
                    case 'categories':
                        this.loadCategories();
                        break;
                    case 'reports':
                        this.loadReports();
                        break;
                    case 'settings':
                        this.loadSettings();
                        break;
                }
            }

            loadDashboardData() {
                this.updateDashboardStats();
                this.loadRecentBooks();
            }

            updateDashboardStats() {
                const books = JSON.parse(localStorage.getItem('shelfOfBooks') || '[]');
                const totalBooks = books.length;
                const favoriteBooks = books.filter(book => book.favorite).length;
                const readBooks = books.filter(book => book.read).length;

                document.getElementById('totalBooks').textContent = totalBooks;
                document.getElementById('favoriteBooks').textContent = favoriteBooks;
                document.getElementById('totalViews').textContent = readBooks;
                document.getElementById('totalUsers').textContent = '1'; // Placeholder
            }

            loadRecentBooks() {
                const books = JSON.parse(localStorage.getItem('shelfOfBooks') || '[]');
                const recentBooksContainer = document.getElementById('recentBooks');
                
                if (recentBooksContainer) {
                    const recentBooks = books.slice(-5).reverse();
                    recentBooksContainer.innerHTML = recentBooks.map(book => `
                        <div class="recent-item">
                            <div class="item-info">
                                <h4>${book.book}</h4>
                                <p>${book.bookauthor}</p>
                                <span class="item-type">${book.bookType}</span>
                            </div>
                        </div>
                    `).join('');
                }
            }

            loadBooks() {
                this.displayBooks();
            }

            displayBooks() {
                const books = JSON.parse(localStorage.getItem('shelfOfBooks') || '[]');
                const tbody = document.getElementById('booksTableBody');
                
                if (tbody) {
                    tbody.innerHTML = books.map((book, index) => `
                        <tr>
                            <td>
                                <div class="book-info">
                                    <h4>${book.book}</h4>
                                    <p>${book.bookType}</p>
                                </div>
                            </td>
                            <td>${book.bookauthor || 'Unknown'}</td>
                            <td><span class="badge">${book.bookType}</span></td>
                            <td>${book.isbn || 'N/A'}</td>
                            <td>
                                <span class="status ${book.favorite ? 'favorite' : ''}">
                                    ${book.favorite ? 'Favorite' : 'Regular'}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-info" onclick="dashboard.viewBook(${index})" title="View Book">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="dashboard.editBook(${index})" title="Edit Book">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="dashboard.removeBook(${index})" title="Delete Book">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }
            }

            initializeBookManagement() {
                // Initialize form immediately
                this.initializeAddBookForm();
                
                // Also initialize when add-book tab is loaded
                const addBookLink = document.querySelector('[data-tab="add-book"]');
                if (addBookLink) {
                    addBookLink.addEventListener('click', () => {
                        setTimeout(() => this.initializeAddBookForm(), 100);
                    });
                }
            }

            initializeAddBookForm() {
                console.log('Initializing add book form...');
                const form = document.getElementById('libraryForm');
                if (form) {
                    console.log('Form found, adding event listener');
                    // Remove existing event listeners
                    form.removeEventListener('submit', this.addBookHandler);
                    
                    // Add new event listener
                    this.addBookHandler = (e) => {
                        e.preventDefault();
                        console.log('Form submitted!');
                        this.addBook();
                    };
                    form.addEventListener('submit', this.addBookHandler);
                } else {
                    console.error('Form not found!');
                }

                // Handle book type selection
                const typeOptions = document.querySelectorAll('input[name="type"]');
                typeOptions.forEach(option => {
                    option.addEventListener('change', (e) => {
                        const newTypeGroup = document.getElementById('newTypeGroup');
                        if (e.target.value === 'Other') {
                            newTypeGroup.style.display = 'block';
                        } else {
                            newTypeGroup.style.display = 'none';
                        }
                    });
                });
            }

            addBook() {
                console.log('Adding book...');
                
                const name = document.getElementById('bookName').value;
                const author = document.getElementById('author').value;
                const isbn = document.getElementById('isbnno').value;
                const edition = document.getElementById('edition').value;
                const publicationDate = document.getElementById('publicationdate').value;
                const bookUrl = document.getElementById('bookurl').value;
                const favorite = document.getElementById('fav-toggle').checked;
                const read = document.getElementById('read-toggle').checked;

                console.log('Form values:', { name, author, isbn, edition, publicationDate, bookUrl, favorite, read });

                // Get selected book type
                const selectedType = document.querySelector('input[name="type"]:checked');
                let type = selectedType ? selectedType.value : 'Other';
                
                if (type === 'Other') {
                    const newType = document.getElementById('newType').value;
                    type = newType || 'Other';
                }

                console.log('Selected type:', type);

                // Validation
                if (!name || !author) {
                    this.showMessage('Book name and author are required!', 'error');
                    return;
                }

                if (isbn && !this.isValidIsbn(isbn)) {
                    this.showMessage('Invalid ISBN number!', 'error');
                    return;
                }

                if (bookUrl && !this.isValidUrl(bookUrl)) {
                    this.showMessage('Invalid URL!', 'error');
                    return;
                }

                // Check if book already exists
                const books = JSON.parse(localStorage.getItem('shelfOfBooks') || '[]');
                const existingBook = books.find(book => 
                    book.book === name && 
                    book.bookauthor === author && 
                    book.bookType === type
                );

                if (existingBook) {
                    this.showMessage('This book is already in your library!', 'error');
                    return;
                }

                // Create book object
                const newBook = {
                    book: name,
                    bookauthor: author,
                    isbn: isbn,
                    edition: edition,
                    publicationDate: publicationDate,
                    bookurl: bookUrl,
                    bookType: type,
                    favorite: favorite,
                    read: read,
                    addedDate: new Date().toISOString()
                };

                console.log('New book object:', newBook);

                // Add to localStorage
                books.push(newBook);
                localStorage.setItem('shelfOfBooks', JSON.stringify(books));

                console.log('Book saved to localStorage. Total books:', books.length);

                // Show success message
                this.showMessage('Book added successfully!', 'success');

                // Reset form
                this.resetForm();

                // Update dashboard
                this.updateDashboardStats();
                this.loadRecentBooks();
                
                // Switch to books tab to show the new book
                this.switchTab('books');
            }

            resetForm() {
                const form = document.getElementById('libraryForm');
                if (form) {
                    form.reset();
                }
                const newTypeGroup = document.getElementById('newTypeGroup');
                if (newTypeGroup) {
                    newTypeGroup.style.display = 'none';
                }
            }

            editBook(index) {
                const books = JSON.parse(localStorage.getItem('shelfOfBooks') || '[]');
                const book = books[index];
                
                // Populate form with book data
                document.getElementById('bookName').value = book.book;
                document.getElementById('author').value = book.bookauthor;
                document.getElementById('isbnno').value = book.isbn || '';
                document.getElementById('edition').value = book.edition || '';
                document.getElementById('publicationdate').value = book.publicationDate || '';
                document.getElementById('bookurl').value = book.bookurl || '';
                document.getElementById('fav-toggle').checked = book.favorite;
                document.getElementById('read-toggle').checked = book.read;

                // Set book type
                const typeInput = document.querySelector(`input[name="type"][value="${book.bookType}"]`);
                if (typeInput) {
                    typeInput.checked = true;
                } else if (book.bookType !== 'Other') {
                    document.querySelector('input[name="type"][value="Other"]').checked = true;
                    document.getElementById('newType').value = book.bookType;
                    document.getElementById('newTypeGroup').style.display = 'block';
                }

                // Switch to add-book tab
                this.switchTab('add-book');
            }

            removeBook(index) {
                if (confirm('Are you sure you want to delete this book?')) {
                    const books = JSON.parse(localStorage.getItem('shelfOfBooks') || '[]');
                    books.splice(index, 1);
                    localStorage.setItem('shelfOfBooks', JSON.stringify(books));
                    
                    this.displayBooks();
                    this.updateDashboardStats();
                    this.loadRecentBooks();
                    this.showMessage('Book removed successfully!', 'success');
                }
            }

            handleSearch(query) {
                const books = JSON.parse(localStorage.getItem('shelfOfBooks') || '[]');
                const filteredBooks = books.filter(book => 
                    book.book.toLowerCase().includes(query.toLowerCase()) ||
                    book.bookauthor.toLowerCase().includes(query.toLowerCase())
                );
                
                this.displayFilteredBooks(filteredBooks);
            }

            displayFilteredBooks(books) {
                const tbody = document.getElementById('booksTableBody');
                if (tbody) {
                    tbody.innerHTML = books.map((book, index) => `
                        <tr>
                            <td>
                                <div class="book-info">
                                    <h4>${book.book}</h4>
                                    <p>${book.bookType}</p>
                                </div>
                            </td>
                            <td>${book.bookauthor || 'Unknown'}</td>
                            <td><span class="badge">${book.bookType}</span></td>
                            <td>${book.isbn || 'N/A'}</td>
                            <td>
                                <span class="status ${book.favorite ? 'favorite' : ''}">
                                    ${book.favorite ? 'Favorite' : 'Regular'}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-info" onclick="dashboard.viewBook(${index})" title="View Book">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="dashboard.editBook(${index})" title="Edit Book">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="dashboard.removeBook(${index})" title="Delete Book">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }
            }

            showMessage(message, type = 'info') {
                const messageDiv = document.getElementById('message');
                if (messageDiv) {
                    messageDiv.textContent = message;
                    messageDiv.className = `notification notification-${type}`;
                    messageDiv.style.display = 'block';
                    
                    setTimeout(() => {
                        messageDiv.style.display = 'none';
                    }, 3000);
                }
                console.log(`${type.toUpperCase()}: ${message}`);
            }

            isValidIsbn(isbn) {
                isbn = isbn.replaceAll("-", "");
                if (isbn.length === 10) {
                    let sum = 0;
                    for (let i = 9; i >= 0; i--) {
                        sum += parseInt(isbn[i], 10) * (i + 1);
                    }
                    return sum % 11 === 0;
                } else if (isbn.length === 13) {
                    let sum = 0;
                    for (let i = 0; i < 13; i++) {
                        if (i % 2 === 0) {
                            sum += parseInt(isbn[i], 10) * 1;
                        } else {
                            sum += parseInt(isbn[i], 10) * 3;
                        }
                    }
                    return sum % 10 === 0;
                }
                return false;
            }

            isValidUrl(urlString) {
                const urlPattern = new RegExp(
                    "^(https?:\\/\\/)?" +
                    "((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|" +
                    "((\\d{1,3}\\.){3}\\d{1,3}))" +
                    "(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*" +
                    "(\\?[;&a-z\\d%_.~+=-]*)?" +
                    "(\\#[-a-z\\d_]*)?$",
                    "i"
                );
                return !!urlPattern.test(urlString);
            }

            loadCategories() {
                // Load categories functionality
                console.log('Loading categories...');
            }

            loadReports() {
                // Load reports functionality
                console.log('Loading reports...');
            }

            loadSettings() {
                // Load settings functionality
                console.log('Loading settings...');
            }

            logout() {
                // Handle logout
                console.log('Logging out...');
            }

            viewBook(index) {
                const books = JSON.parse(localStorage.getItem('shelfOfBooks') || '[]');
                const book = books[index];
                
                if (!book) {
                    this.showMessage('Book not found!', 'error');
                    return;
                }

                // Store current book index for download
                this.currentBookIndex = index;
                
                // Update modal title
                document.getElementById('modalBookTitle').textContent = book.book;
                
                // Create book details content
                const bookContent = `
                    <div class="book-details">
                        <div class="book-header">
                            <div class="book-cover">
                                <i class="fas fa-book-open"></i>
                            </div>
                            <div class="book-info">
                                <h3>${book.book}</h3>
                                <p class="author">by ${book.bookauthor || 'Unknown Author'}</p>
                                <span class="book-type">${book.bookType}</span>
                            </div>
                        </div>
                        
                        <div class="book-details-grid">
                            <div class="detail-item">
                                <label>ISBN:</label>
                                <span>${book.isbn || 'Not available'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Edition:</label>
                                <span>${book.edition || 'Not specified'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Publication Date:</label>
                                <span>${book.publicationDate || 'Not available'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Added Date:</label>
                                <span>${new Date(book.addedDate).toLocaleDateString()}</span>
                            </div>
                            <div class="detail-item">
                                <label>Status:</label>
                                <span>
                                    ${book.favorite ? '<i class="fas fa-star" style="color: gold;"></i> Favorite' : 'Regular'}
                                    ${book.read ? ' | <i class="fas fa-check" style="color: green;"></i> Read' : ''}
                                </span>
                            </div>
                        </div>
                        
                        ${book.bookurl ? `
                            <div class="book-url">
                                <label>Book URL:</label>
                                <a href="${book.bookurl}" target="_blank" class="book-link">
                                    <i class="fas fa-external-link-alt"></i> Open Book URL
                                </a>
                            </div>
                        ` : ''}
                        
                        <div class="book-actions">
                            <button class="btn btn-primary" onclick="dashboard.openBookUrl('${book.bookurl}')" ${!book.bookurl ? 'disabled' : ''}>
                                <i class="fas fa-external-link-alt"></i> Open Book
                            </button>
                            ${book.bookurl ? `
                                <button class="btn btn-success" onclick="dashboard.downloadBook(${index})">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                // Update modal content
                document.getElementById('modalBookContent').innerHTML = bookContent;
                
                // Show download button if URL exists
                const downloadBtn = document.getElementById('downloadBookBtn');
                if (downloadBtn) {
                    downloadBtn.style.display = book.bookurl ? 'inline-block' : 'none';
                }
                
                // Show modal
                document.getElementById('bookViewerModal').style.display = 'flex';
            }

            openBookUrl(url) {
                if (url) {
                    window.open(url, '_blank');
                } else {
                    this.showMessage('No URL available for this book', 'error');
                }
            }

            downloadBook(index) {
                const books = JSON.parse(localStorage.getItem('shelfOfBooks') || '[]');
                const book = books[index];
                
                if (!book || !book.bookurl) {
                    this.showMessage('No download URL available for this book', 'error');
                    return;
                }

                try {
                    // Create a temporary link element to trigger download
                    const link = document.createElement('a');
                    link.href = book.bookurl;
                    link.download = `${book.book} - ${book.bookauthor}.pdf`;
                    link.target = '_blank';
                    
                    // Add to DOM, click, and remove
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.showMessage('Download started!', 'success');
                } catch (error) {
                    console.error('Download error:', error);
                    this.showMessage('Download failed. Please try opening the book URL instead.', 'error');
                }
            }

            closeBookModal() {
                document.getElementById('bookViewerModal').style.display = 'none';
                this.currentBookIndex = null;
            }
        }

        // Initialize the dashboard when the page loads
        let dashboard;
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing dashboard...');
            dashboard = new ManagementDashboard();
        });

        // Global functions for button clicks
        function showAddBookTab() {
            dashboard.switchTab('add-book');
        }

        function resetForm() {
            dashboard.resetForm();
        }

        function showAddCategoryModal() {
            console.log('Show add category modal');
        }

        function closeBookModal() {
            dashboard.closeBookModal();
        }

        function downloadBook() {
            if (dashboard.currentBookIndex !== null) {
                dashboard.downloadBook(dashboard.currentBookIndex);
            }
        }
    </script>
</body>
</html>